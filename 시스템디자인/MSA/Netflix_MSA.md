### MSA에서 중요한 요소 중 하나는 자동 확장(Auto Scale-out)이다.

- **자동 확장**이란 특정 서비스에 트래픽이나 부하가 증가할 경우 인스턴스를 추가로 생성하고, 반대로 트래픽과 부하가 감소할 경우 불필요한 인스턴스를 서비스에서 제거하는 것을 의미한다.
- 서비스 단위로 자동 확장이 가능해 시스템 자원 활용을 최적화할 수 있지만 구현하기 위해서는 고려해야할 것들이 많다.

<br>
<br>

### Spring Cloud Netflix

- Spring Cloud는 Spring boot를 기반으로 MSA 구축에 특화된 라이브러리들의 집합.
- Spring Cloud에는 Eureka, Hystrix, Ribbon, Zuul 등 많은 넷플릭스 OSS가 통합되어 있다.

<br>
<br>

### 서비스 디스커버리 서버 - Eureka

인스턴스의 상태를 동적으로 관리하는 서버

- 새로운 인스턴스는 시작할 때 Eureka 서버에 IP, 호스트 주소, 포트 정보 등을 스스로 전송한다.
- Eureka 서버는 받은 정보를 가지고 일정한 간격으로 상태를 체크하면서 해당 인스턴스를 관리한다.
- 인스턴스가 새로 실행될 때마다 자신의 정보를 서버에 동적으로 등록하기 때문에 운영자들은 서비스를 수평 확장할 때 IP 정보에 대해 신경 쓸 필요가 없다.

<br>

운영자들은 설정 파일에 Eureka 서버 정보만 입력하면 되고, 서비스들은 다른 서비스를 호출할 때 Eureka 서버에 등록된 인스턴스를 조회하면 된다.

<br>
<br>

### 클라이언트 사이드 로드 밸런서 - Ribbon

모놀리식 시스템에서는 부하 분산을 위해 L4 스위치 같은 하드웨어 장비를 앞단에 두고 트래픽을 여러 서버로 분산한다.

- 중앙 집중화된 방식은 로드 밸런서에 장애가 발생하면 전체 서비스에 문제가 생기는 위험을 동반한다.
- 동적으로 서버가 추가, 삭제되는 환경에서 하드웨어 장비로 대응하는 것도 한계가 있다.

<br>

넷플릭스는 소프트웨어로 구현한 클라이언트 로드 밸런서인 Ribbon을 추가했다.

- 클라이언트는 MSA에서 다른 서비스를 호출하는 클라이언트 서비스를 뜻한다.
- 클라이언트 서비스는 부하 분산 알고리즘에 따라 서버 목록 중 하나를 선택하여 호출한다.
- 서버 목록은 정적 리스트를 사용하면 되지만 앞에서 설명한 Eureka와 연동할 경우에는 동적 리스트로 가능하다.
- 사용 가능한 알고리즘
    - 순서대로 선택하는 Simple round robin
    - 서버의 응답 시간에 따라 선택하는 Weighted response time
    - 3회 연속 호출 실패 시 30초 동안 목록에서 제외하는 Availability filtering 등 …
    - Zone-aware round robin, Random load balancing 등

<br>
<br>

### 서킷 브레이커 - Hystrix

MSA도 특정 서비스에 과부하가 걸리거나 어떤 문제로 인해 정상적으로 작동하지 않으면 전체 서비스에 장애를 전파하는 경우가 있다.

<br>

특정 서비스에 문제가 생기더라도 전체적으로 장애가 확산하지 않도록 차단해주는 기능을 서킷 브레이커라고 하며 넷플릭스는 이를 Hystrix라는 이름으로 개발했다.

- Hystrix 서버는 각 서비스의 오류 상태나 복구 상태 그리고 현재 오류 내용이 무엇인지를 파악한다.
- API 호출 통계를 기반으로 상대 서비스에서 이상을 감지하면 즉시 통신을 중단한다.
- 문제가 있던 서비스를 격리하게 되는데 이후에는 문제가 해결될 때까지 별도의 스레드에서 밀린 작업을 수행하거나 호출 수를 제한한다.
- 상태가 정상으로 돌아오면 통신을 연결하여 다시 호출을 받도록 한다.

<br>

서킷 브레이커의 폴백(Fallback) 기능

- 폴백은 정해진 시간 내에 호출이 실패하면 대신 동작하는 예외처리이다.
- 개발자가 폴백 메소드를 구현함으로써 시스템 장애로부터 유연하게 복구를 실행할 수 있다.
- 서킷 브레이커의 정보나 각 서버의 상태를 확인할 수 있는 모니터링 서비스까지 제공하여 로그를 중앙 집중형으로 관리하고 검색할 수 있다.

<br>
<br>

### API 게이트웨이 - Zuul

Zuul은 넷플릭스가 개발한 Spring Cloud Netflix에 특화된 API 게이트웨어이다.

- API 게이트웨이는 사용자 요청을 적절한 서비스로 프록시 혹은 라우팅하는 MSA의 컴포넌트이다.
- Zuul은 최전방에서 클라이언트의 요청을 받아 적절한 서비스에 전달하고 결과를 다시 클라이언트에 보내는 엣지 서버로 보면 된다.

<br>

사용자에게 Zuul만 노출하고 다른 마이크로서비스의 종단점(엣지)를 숨기는 이유?

- MSA 환경은 하나의 서비스에 여러 개의 서버가 존재할 수 있기 때문에 사용자에게 다수의 진입점(End Point)이 생겨난다.
- 진입점은 인증과 보안, 잘못된 요청 등을 처리하는데 일부 진입점에 변경이 생길 경우 전체가 영향을 받기 때문에 관리가 까다롭다.
- 이때, Zuul을 활용해 도메인을 하나로 통합하고 단일 진입점으로 사용한다면 관리가 수월해진다.

<br>

Zuul의 필터 기능

- 사용자가 많은 서비스에는 다양한 형태의 요청이 쏟아진다.
    - 요청 중에는 예상치 못한 것도 있어 운영 이슈가 발생할 수 있다.
- Zuul 필터는 사용자 요청에 대해 각 리소스의 인증 요구사항을 식별하고 이를 만족시키지 않는 요청은 거부한다.
- 필터는 동적으로 작동하기 때문에 정책이 바뀌어도 별도의 배포없이 반영할 수 있다.
- 데이터 및 통계를 분석하여 모니터링이 가능하다.
- 스트레스 테스트, 멀티 리전 복원 등의 기능도 지원한다.

<br>
<br>
reference - https://www.samsungsds.com/kr/insights/msa_and_netflix.html